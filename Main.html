<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <link rel="stylesheet" type="text/css" href="css/mainStyles.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <div class="all">
        <div class="camera">
             <div class="charactermap">
                <img class="map">
                 <img class="item" id="item1" src="item.png">
                 <img class="item" id="item2" src="item.png">
                 <img class="item" id="item3" src="item.png">
                 <img class="item" id="item4" src="item.png">
                 <img class="item" id="item5" src="item.png">
                 <img class="item" id="item6" src="item.png">
                 <img class="item" id="item7" src="item.png">
                 <img class="item" id="item8" src="item.png">
                 <img class="item" id="item9" src="item.png">
                <img id="door" src="exit.png">
            </div>
            <div class="center">
               <div class="character">
                   <img src="characterfin.png">
               </div>
           </div>
        </div>
        <div class="walk">
               <div id="control">
                    <div id="up" onclick="move(87)">
                        <img class="direction" src="fangxiang1.png">
                    </div>
                   
                    <div id="left" onclick="move(65)"><img class="direction" src="fangxiang1.png"></div>
                    <div id="right" onclick="move(68)"><img class="direction" src="fangxiang1.png"></div>
                     <div id="down" onclick="move(83)">
                   <img class="direction" src="fangxiang1.png"></div>
                </div>
            </div>
         <div id="talk">
             <div id="choiceposition"></div>
         </div>
     </div>
    <script type="text/javascript">
        var direction = document.getElementsByClassName("direction");
        var charactermap=document.getElementsByClassName("charactermap")[0];
        var charactercamera=document.getElementsByClassName("camera")[0];
        var character=document.getElementsByClassName("character")[0].children[0];
        var animationcount=0;
        var charactertransfrom=0;
        var ancount=0;
        var pixelSize = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--pixel-size'));
        var camera_left;
        var camera_top;
        var mapA=[1,1,0,1,1,0,1,1,0,1];
        var mapB=[1,0,1,0,1,1,1,0,0,1];
        var mapC=[1,1,1,1,0,1,0,1,0,1];
        var mapD=[1,0,0,0,0,1,0,1,0,1];
        var mapE=[1,1,1,1,1,1,0,1,1,1];
        var mapF=[1,0,0,0,1,0,1,0,1,0];
        var mapG=[1,1,0,1,1,0,1,0,1,1];
        var mapH=[0,1,0,0,1,0,1,0,0,1];
        var mapI=[1,1,1,0,1,1,1,1,0,1];
        var mapJ=[1,0,0,1,1,0,0,1,1,1];
        var mapall =[mapA,mapB,mapC,mapD,mapE,mapF,mapG,mapH,mapI,mapJ];
        var currentX;
        var currentY;
        var checkMap;
        var stop=0;
        var choices;
        var div= document.getElementById("talk");
        var items = document.getElementsByClassName("item");
        var checkitems;
        var itemsnum=0;
        var score;
        var windowidth0=window.innerWidth;
        var windowidth=window.innerWidth;
        console.log(windowidth);
        var url = window.location.search;
        var count;
        start();
        resize();
        function resize(){
            windowidth=window.innerWidth;
            score=score-10;
            if(windowidth!=windowidth0){
                windowidth0=windowidth;
                camera_left = camera_left/pixelSize;
                camera_top = camera_top/pixelSize;
                charactertransfrom=charactertransfrom/pixelSize;
                pixelSize = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--pixel-size'));
                camera_left = camera_left*pixelSize;
                camera_top = camera_top*pixelSize;
                charactertransfrom=charactertransfrom*pixelSize;
                charactermap.style.transform = `translate3d(${-camera_left}px,${-camera_top}px,0)`;
            }
            setTimeout(function(){resize();},500)
        }
        function start(){
            console.log("start");
            if(url!=""){
                if(url.indexOf("?")!=1){
                    var fromanothergame = url.substr(url.indexOf("=")+1)
                    console.log("from another game");
                    console.log(fromanothergame);
                    var i=0;
                    var l=0;
                    do{
                        if(fromanothergame[i]==","){
                            l++
                        }
                        else{
                            switch(l){
                                    case(0):currentX=parseInt(fromanothergame[i]);
                                            console.log(currentX);
                                            break;
                                    case(1):currentY=parseInt(fromanothergame[i]);
                                            console.log(currentY);
                                            break;
                            }
                        }
                        i++;
                    }while(fromanothergame[i]!=null);
                    checkMap=mapall[currentY];
                    camera_left=(currentX-1)*50*pixelSize;
                    camera_top=(currentY-1)*50*pixelSize;;
                     checkitems=[1,1,1,1,1,1,1,1,1,1];
                    charactermap.style.transform = `translate3d(${-camera_left}px,${-camera_top}px,0)`;
                }
            }
            else{
                currentX=0;
                currentY=4;
                checkMap=mapall[currentY];
                console.log(pixelSize);
                characteranimation1();
                checkitems=[1,1,1,1,1,1,1,1,1,1];
                camera_left = -50*pixelSize;
                camera_top = 150*pixelSize;
                score=1000;
                count=1;
                charactermap.style.transform = `translate3d(${-camera_left}px,${-camera_top}px,0)`;
            }
        }
        function characteranimation1(){
            if(ancount<4){
                charactertransfrom=charactertransfrom-75*pixelSize;
                character.style.transform=`translateX(${charactertransfrom}px)`;
                ancount++;
                setTimeout(function(){characteranimation1();},500)
            }
            else{
                characteranimation2();
            }
        }
        function characteranimation2(){
            if(ancount>0){
                charactertransfrom=charactertransfrom+75*pixelSize;
                character.style.transform=`translateX(${charactertransfrom}px)`;
                ancount--;
                setTimeout(function(){characteranimation2();},500)
            }
            else{
                characteranimation1();
            }
        }
        window.addEventListener("keydown",move,false);
        function move(key){
            if(stop==0){
                if(currentX!=0){
                    if(key.keyCode=="65"||key==65){
                        console.log("Pressed a");
                        if(checkMap[currentX-1]==1){
                            currentX=currentX-1;
                            camera_left=camera_left-50*pixelSize;
                            charactermap.style.transform = `translate3d(${-camera_left}px,${-camera_top}px,0)`;
                            score=score-100;
                        }
                    }
                }
                if(currentY!=9){
                    if(key.keyCode=="83"||key==83){
                        console.log("Pressed s");
                        checkMap=mapall[currentY+1];
                        if(checkMap[currentX]==1){
                            currentY=currentY+1;
                            camera_top=camera_top+50*pixelSize;
                            charactermap.style.transform = `translate3d(${-camera_left}px,${-camera_top}px,0)`;
                            score=score-100;
                        }
                        else{
                            checkMap=mapall[currentY];
                        }
                    }
                }
                if(currentX!=9){
                    if(key.keyCode=="68"||key==68){
                        console.log("Pressed d");
                        if(checkMap[currentX+1]==1){
                            currentX=currentX+1;
                            camera_left=camera_left+50*pixelSize;
                            charactermap.style.transform = `translate3d(${-camera_left}px,${-camera_top}px,0)`;
                            score=score-100;
                        }
                    }
                }
                if(currentY!=0){
                    if(key.keyCode=="87"||key==87){
                        console.log("Pressed w");
                        checkMap=mapall[currentY-1];
                        if(checkMap[currentX]==1){
                            currentY=currentY-1;
                            camera_top=camera_top-50*pixelSize;
                            charactermap.style.transform = `translate3d(${-camera_left}px,${-camera_top}px,0)`;
                            score=score-100;
                        }
                        else{
                            checkMap=mapall[currentY];
                        }
                    }
                }
                console.log(currentX+""+currentY);
                if(currentX==1&&currentY==0&&checkitems[0]==1){
                    stop=1;
                    eventitem("在地上發現一盒子","打開","離開",2,0);
                }
                if(currentX==3&&currentY==2&&checkitems[1]==1){
                    stop=1;
                    eventitem("在地上發現一盒子","打開","離開",2,1);
                }
                if(currentX==3&&currentY==0&&checkitems[2]==1){
                    stop=1;
                    eventitem("在地上發現一盒子","打開","離開",2,2);
                }
                if(currentX==7&&currentY==0&&checkitems[3]==1){
                    stop=1;
                    eventitem("在地上發現一盒子","打開","離開",2,3);
                }
                if(currentX==3&&currentY==9&&checkitems[4]==1){
                    stop=1;
                    eventitem("在地上發現一盒子","打開","離開",2,4);
                }
                if(currentX==2&&currentY==8&&checkitems[5]==1){
                    stop=1;
                    eventitem("在地上發現一盒子","打開","離開",2,5);
                }
                if(currentX==0&&currentY==9&&checkitems[6]==1){
                    stop=1;
                    eventitem("在地上發現一盒子","打開","離開",2,6);
                }
                if(currentX==6&&currentY==5&&checkitems[7]==1){
                    stop=1;
                    eventitem("在地上發現一盒子","打開","離開",2,7);
                }
                if(currentX==7&&currentY==2&&checkitems[8]==1){
                    stop=1;
                    eventitem("在地上發現一盒子","打開","離開",2,8);
                }
            }
        }
        function eventitem(text,choice1,choice2,choicenum,itemnum){
            for(i=0; i<4;i++){
            direction[i].style.display ="none";
            }
            itemsnum=itemnum;
            div.style.display="initial";
            div.children[0].innerHTML=text;
            choices= document.createElement("div");
            choices.className="choice";
            console.log(div);
            div.children[0].appendChild(choices);
            choices.appendChild(document.createElement("div"));
            choices.children[0].style.display="initial";
            choices.children[0].innerHTML=choice1;
            if(itemsnum==0){
                choices.children[0].addEventListener("click",anothergame);
            }
            else{
                choices.children[0].addEventListener("click",anothergame);
            }
            choices.appendChild(document.createElement("div"));
            choices.children[1].innerHTML=choice2;
            if(choicenum==2){
                choices.children[1].style.display="initial";
                choices.children[1].addEventListener("click",leave);
            }
        }
        function eventresult(){
            choices.children[0].style.display="none";
            choices.children[1].style.display="none";
            div.style.display="none";
            items[itemsnum].style.display="none";
            checkitems[itemsnum]=0;
            stop=0;
        }
        
        function leave(){
            for(i=0; i<4;i++){
            direction[i].style.display ="block";
            }
            choices.children[0].style.display="none";
            choices.children[1].style.display="none";
            div.style.display="none";
            stop=0;
        }
        function getitem(){
            
        }
        function anothergame(){
            var toanothergame = [currentX,currentY,count,score];
            if(count>5){
                window.location.href="21point.html?value="+toanothergame;
            }
            else{
                window.location.href="flipcardGame.html?value="+toanothergame;
            }
        }
  //document.write(id)
    </script>
</body>
</html>